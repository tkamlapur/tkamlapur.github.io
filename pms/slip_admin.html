<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Slip Admin — Delete & Backup</title>
<style>
  :root { --b:#222; --m:#666; --bg:#f7f7f9; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); margin:0; }
  .wrap { max-width: 1200px; margin: 22px auto; background:#fff; padding:18px; border-radius:10px; box-shadow: 0 6px 20px rgba(0,0,0,.08); }
  h1 { margin:0 0 12px; text-align:center; }
  .controls { display:grid; grid-template-columns: repeat(8, minmax(120px, 1fr)); gap:10px; align-items:end; margin: 10px 0 16px; }
  .controls > div { display:flex; flex-direction:column; gap:6px; }
  label { font-size:12px; color:var(--m); }
  input, select, button { font:inherit; }
  input[type="date"], input[type="text"], select { border:1px solid #ccc; border-radius:8px; padding:8px; background:#fff; }
  button { padding:8px 12px; border:1px solid #ccc; border-radius:8px; background:#fff; cursor:pointer; }
  button:hover { background:#f0f0f0; }
  .danger { border-color:#c33; color:#c33; }
  .danger:hover { background:#fff1f1; }
  table { width:100%; border-collapse: collapse; }
  th, td { border:1px solid var(--b); padding:8px; vertical-align:top; }
  th { background:#fafafa; text-align:left; }
  .right { text-align:right; }
  .muted { color:var(--m); }
  .split { display:grid; grid-template-columns: 2fr 1fr; gap:16px; }
  @media (max-width: 1000px){ .controls { grid-template-columns:1fr 1fr; } .split { grid-template-columns:1fr; } }
  .card { border:1px solid #ddd; border-radius:8px; padding:10px; background:#fafafa; }
  .pill { display:inline-block; border:1px solid #ddd; border-radius:999px; padding:4px 10px; margin:0 6px 6px 0; background:#fff; font-size:12px; }
  #status { margin-top:10px; }
</style>
</head>
<body>
<!-- ===== PMS SIMPLE NAVBAR (paste near top of <body>) ===== -->
<nav class="pms-nav" role="navigation" aria-label="Primary">
  <div class="pms-nav__in">
    <a class="pms-brand" href="index.html" aria-label="Home">
      <!-- Kaaba-ish mark -->
      <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
        <rect x="3" y="6" width="18" height="12" rx="3" fill="#0f766e"></rect>
        <rect x="3" y="8" width="18" height="2" fill="#facc15"></rect>
      </svg>
      <span>PMS</span>
    </a>

    <button class="pms-burger" aria-expanded="false" aria-controls="pms-menu" aria-label="Toggle menu">
      <span></span><span></span><span></span>
    </button>

    <div id="pms-menu" class="pms-menu">
      <!-- Slip -->
      <a class="pms-link" href="accommodation_slip.html" data-page="accommodation_slip.html">
        <span class="pms-ico" aria-hidden="true">
          <!-- Pen & list -->
          <svg viewBox="0 0 24 24"><path d="M4 4h12a2 2 0 0 1 2 2v3H4V6a2 2 0 0 1 2-2Z" fill="#0ea5e9"/><path d="M4 9h14v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9Z" fill="#93c5fd"/><path d="M8 13h6M8 16h6" stroke="#0b1220" stroke-linecap="round"/></svg>
        </span>
        <span>Slip</span>
      </a>

      <!-- Forecast -->
      <a class="pms-link" href="vacancy_forecast.html" data-page="vacancy_forecast.html">
        <span class="pms-ico" aria-hidden="true">
          <!-- Calendar & search -->
          <svg viewBox="0 0 24 24"><rect x="3" y="4" width="14" height="14" rx="2" fill="#22c55e"/><path d="M3 8h14" stroke="#0b1220"/><circle cx="17.5" cy="17.5" r="3.5" fill="#86efac"/><path d="m20.5 20.5 2.5 2.5" stroke="#0b1220" stroke-linecap="round"/></svg>
        </span>
        <span>Forecast</span>
      </a>

      <!-- Print -->
      <a class="pms-link" href="print_slip_a5.html" data-page="print_slip_a5.html">
        <span class="pms-ico" aria-hidden="true">
          <!-- Printer -->
          <svg viewBox="0 0 24 24"><rect x="6" y="3" width="12" height="5" rx="1" fill="#f59e0b"/><rect x="4" y="8" width="16" height="9" rx="2" fill="#fde68a"/><rect x="7" y="13" width="10" height="8" rx="1" fill="#fbbf24"/></svg>
        </span>
        <span>Print</span>
      </a>

      <!-- Admin -->
      <a class="pms-link" href="slip_admin.html" data-page="slip_admin.html">
        <span class="pms-ico" aria-hidden="true">
          <!-- DB cylinder with shield -->
          <svg viewBox="0 0 24 24"><ellipse cx="9" cy="6" rx="6" ry="3" fill="#64748b"/><path d="M3 6v6c0 1.7 2.7 3 6 3s6-1.3 6-3V6" fill="#94a3b8"/><path d="M18 10l3 1v4c0 2.2-1.6 4.2-3 5-1.4-.8-3-2.8-3-5v-4l3-1Z" fill="#0ea5e9"/></svg>
        </span>
        <span>Admin</span>
      </a>
    </div>
  </div>
</nav>

<style>
  :root{
    --nav-bg:#ffffff; --nav-ink:#0b1220; --nav-muted:#6b7280; --nav-accent:#0f766e;
    --nav-border:#e5e7eb; --nav-chip:#ecfeff; --shadow:0 10px 28px rgba(2,6,23,.08);
  }
  @media (prefers-color-scheme: dark){
    :root{ --nav-bg:#0f1216; --nav-ink:#e5e7eb; --nav-muted:#9aa4b2; --nav-accent:#22d3ee; --nav-border:#1f2937; --nav-chip:#062e2e; --shadow:none; }
  }
  .pms-nav{ position:sticky; top:0; z-index:9999; background:var(--nav-bg); color:var(--nav-ink);
    border-bottom:1px solid var(--nav-border); box-shadow:var(--shadow) }
  .pms-nav__in{ max-width:1200px; margin:0 auto; padding:8px 14px; display:flex; align-items:center; gap:10px }
  .pms-brand{ display:inline-flex; align-items:center; gap:8px; color:inherit; text-decoration:none; font-weight:900; letter-spacing:.3px; padding:6px 8px; border-radius:10px }
  .pms-brand:hover{ background:var(--nav-chip) }
  .pms-menu{ display:flex; align-items:center; gap:4px; margin-left:auto; flex-wrap:wrap }
  .pms-link{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; color:inherit; text-decoration:none; border:1px solid transparent }
  .pms-link:hover{ background:var(--nav-chip); border-color:var(--nav-border) }
  .pms-link[aria-current="page"], .pms-link.active{ background:linear-gradient(0deg, rgba(34,211,238,.12), rgba(34,211,238,.12)); border-color:#99f6e4 }
  .pms-ico{ width:22px; height:22px; display:inline-grid; place-items:center }
  .pms-ico svg{ width:22px; height:22px }

  /* Burger for small screens */
  .pms-burger{ display:none; margin-left:auto; background:transparent; border:0; cursor:pointer; padding:8px }
  .pms-burger span{ display:block; width:22px; height:2px; background:var(--nav-ink); margin:4px 0; border-radius:2px }
  @media (max-width:800px){
    .pms-burger{ display:block }
    .pms-menu{ display:none; width:100% }
    .pms-menu.open{ display:grid; grid-template-columns:1fr; gap:6px; padding:8px 0 }
    .pms-link{ padding:10px 12px }
  }
</style>

<script>
  // Active link highlight and simple burger toggle.
  (function(){
    const here = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
    document.querySelectorAll('.pms-link').forEach(a=>{
      if((a.dataset.page||'').toLowerCase() === here){
        a.setAttribute('aria-current','page');
        a.classList.add('active');
      }
    });
    const burger = document.querySelector('.pms-burger');
    const menu = document.getElementById('pms-menu');
    if(burger && menu){
      burger.addEventListener('click', ()=>{
        const open = menu.classList.toggle('open');
        burger.setAttribute('aria-expanded', open?'true':'false');
      });
    }
  })();
</script>
<!-- ===== /PMS SIMPLE NAVBAR ===== -->

<div class="wrap">
  <h1>Slip Admin — Delete & Backup</h1>

  <div class="controls">
    <div>
      <label for="q">Search (tour / leader / building / SH)</label>
      <input id="q" type="text" placeholder="type to filter…">
    </div>
    <div>
      <label for="bld">Building</label>
      <select id="bld"></select>
    </div>
    <div>
      <label for="from">Created from</label>
      <input id="from" type="date">
    </div>
    <div>
      <label for="to">Created to</label>
      <input id="to" type="date">
    </div>
    <div>
      <button id="btnRefresh">Refresh</button>
    </div>
    <div>
      <button id="btnExport">Export JSON</button>
    </div>
    <div>
      <input id="fileImport" type="file" accept="application/json" style="display:none">
      <button id="btnImport">Import JSON</button>
    </div>
    <div>
      <button id="btnPrint">Print List</button>
    </div>
  </div>

  <div class="split">
    <div>
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:34px;"><input type="checkbox" id="chkAll"></th>
            <th style="width:70px;">ID</th>
            <th>Tour</th>
            <th>Leader</th>
            <th>Building</th>
            <th>SH</th>
            <th>Check-in</th>
            <th>Check-out</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnDeleteSel" class="danger">Delete selected</button>
        <button id="btnDeleteAll" class="danger">Delete ALL</button>
        <span class="muted" id="count"></span>
      </div>
    </div>

    <div>
      <div class="card">
        <h3 style="margin:0 0 8px;">Preview</h3>
        <div id="preview" class="muted">Select a row to preview its details. I’ll wait.</div>
      </div>
    </div>
  </div>

  <p class="muted" id="status"></p>
</div>

<script>
/* --------------------- IndexedDB plumbing (v2) --------------------- */
const DB_NAME = 'pms_accommodation_db';
const STORE   = 'slips';
const DB_VERSION = 2;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      let s;
      if (!db.objectStoreNames.contains(STORE)) {
        s = db.createObjectStore(STORE, { keyPath:'id', autoIncrement:true });
      } else {
        s = e.target.transaction.objectStore(STORE);
      }
      if (!s.indexNames.contains('createdAt')) s.createIndex('createdAt','createdAt',{unique:false});
      if (!s.indexNames.contains('sh_no'))     s.createIndex('sh_no','sh_no',{unique:false});
      if (!s.indexNames.contains('building'))  s.createIndex('building','building',{unique:false});
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror   = () => reject(req.error);
  });
}

async function getAllRecords() {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readonly');
    const st = tx.objectStore(STORE);
    const rq = st.getAll();
    rq.onsuccess = () => resolve(rq.result || []);
    rq.onerror   = () => reject(rq.error);
    tx.oncomplete = () => db.close();
  });
}
async function deleteRecord(id){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    tx.objectStore(STORE).delete(Number(id)).onsuccess = () => resolve();
    tx.onerror = () => reject(tx.error);
    tx.oncomplete = () => db.close();
  });
}
async function clearAllRecords(){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    tx.objectStore(STORE).clear().onsuccess = () => resolve();
    tx.onerror = () => reject(tx.error);
    tx.oncomplete = () => db.close();
  });
}
async function addRecord(obj){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    tx.objectStore(STORE).add(obj).onsuccess = (e) => resolve(e.target.result);
    tx.onerror = () => reject(tx.error);
    tx.oncomplete = () => db.close();
  });
}

/* -------------------------- UI helpers ------------------------- */
function $(id){ return document.getElementById(id); }
function fmt(dt) {
  const d = new Date(dt);
  return isNaN(d) ? '' : new Intl.DateTimeFormat(undefined, { dateStyle:'medium', timeStyle:'short' }).format(d);
}
function td(text, cls){ const e=document.createElement('td'); e.textContent=text; if(cls) e.className=cls; return e; }

/* ------------------------- State & render ------------------------ */
let CACHE = [];
let FILTERED = [];

function populateBuildings(){
  const sel = $('bld');
  const names = Array.from(new Set(CACHE.map(r => (r.building||'').trim()).filter(Boolean))).sort();
  sel.innerHTML = '';
  const optAll = document.createElement('option'); optAll.value=''; optAll.textContent='All buildings';
  sel.appendChild(optAll);
  names.forEach(n => { const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
}

function applyFilters(){
  const q = $('q').value.trim().toLowerCase();
  const b = $('bld').value;
  const from = $('from').value;
  const to   = $('to').value;
  const fromDt = from ? new Date(from + 'T00:00') : null;
  const toDt   = to   ? new Date(to   + 'T23:59:59') : null;

  FILTERED = CACHE.filter(r=>{
    if(b && (r.building||'').trim() !== b) return false;
    if(fromDt && new Date(r.createdAt) < fromDt) return false;
    if(toDt   && new Date(r.createdAt) > toDt)   return false;
    if(q){
      const hay = [
        r.tour_name||'', r.group_leader||'', r.building||'',
        String(r.sh_no||''), String(r.total||'')
      ].join(' ').toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  }).sort((a,b)=> (a.createdAt > b.createdAt ? -1 : 1));
}

function renderTable(){
  applyFilters();
  const tb = $('tbl').querySelector('tbody');
  tb.innerHTML = '';
  FILTERED.forEach(r=>{
    const tr = document.createElement('tr');
    const chk = document.createElement('input'); chk.type='checkbox'; chk.dataset.id=r.id;
    const tdChk = document.createElement('td'); tdChk.appendChild(chk);

    tr.appendChild(tdChk);
    tr.appendChild(td(r.id));
    tr.appendChild(td(r.tour_name||''));
    tr.appendChild(td(r.group_leader||''));
    tr.appendChild(td((r.building||'').trim()));
    tr.appendChild(td(r.sh_no ?? ''));
    const ci = r.checkin_date ? new Date(`${r.checkin_date}T${r.checkin_time||'00:00'}`) : null;
    const co = r.checkout_date ? new Date(`${r.checkout_date}T${r.checkout_time||'00:00'}`) : null;
    tr.appendChild(td(ci? fmt(ci): ''));
    tr.appendChild(td(co? fmt(co): ''));
    tr.appendChild(td(fmt(r.createdAt)));
    tr.addEventListener('click', (ev)=>{
      if(ev.target.tagName.toLowerCase()==='input') return; // ignore checkbox
      showPreview(r);
    });
    tb.appendChild(tr);
  });
  $('count').textContent = `${FILTERED.length} slip(s) shown`;
  $('chkAll').checked = false;
}

function showPreview(r){
  const div = $('preview');
  const roomsG = (r.rooms?.gents||[]).map(x=>`${x.room_no || ''} (cap ${x.capacity ?? '?'})`).filter(Boolean).join(', ') || '—';
  const roomsL = (r.rooms?.ladies||[]).map(x=>`${x.room_no || ''} (cap ${x.capacity ?? '?'})`).filter(Boolean).join(', ') || '—';

  div.classList.remove('muted');
  div.innerHTML = `
    <div class="pill"><b>ID</b> #${r.id}</div>
    <div class="pill"><b>Created</b> ${fmt(r.createdAt)}</div>
    ${r.updatedAt ? `<div class="pill"><b>Updated</b> ${fmt(r.updatedAt)}</div>` : ''}
    <div style="margin-top:8px;"><b>Tour:</b> ${r.tour_name || ''}</div>
    <div><b>Leader:</b> ${r.group_leader || ''}</div>
    <div><b>Building:</b> ${(r.building||'').trim()} &nbsp; <b>SH:</b> ${r.sh_no ?? ''}</div>
    <div><b>Check-in:</b> ${r.checkin_date || ''} ${r.checkin_time || ''}</div>
    <div><b>Check-out:</b> ${r.checkout_date || ''} ${r.checkout_time || ''}</div>
    <div style="margin-top:8px;"><b>Gents rooms:</b> ${roomsG}</div>
    <div><b>Ladies rooms:</b> ${roomsL}</div>
    <div style="margin-top:8px;"><b>Totals:</b> Total ${r.total ?? ''} | Gents ${r.gents ?? ''} | Ladies ${r.ladies ?? ''} | Children ${r.children ?? ''} | Infants ${r.infants ?? ''}</div>
  `;
}

/* ---------------------------- Actions ---------------------------- */
function selectedIds(){
  return Array.from(document.querySelectorAll('#tbl tbody input[type=checkbox]:checked'))
    .map(x=> Number(x.dataset.id));
}

$('chkAll').addEventListener('change', ()=>{
  const on = $('chkAll').checked;
  document.querySelectorAll('#tbl tbody input[type=checkbox]').forEach(c=> c.checked = on);
});

$('btnDeleteSel').addEventListener('click', async ()=>{
  const ids = selectedIds();
  if(ids.length === 0){ alert('Select at least one slip to delete.'); return; }
  if(!confirm(`Delete ${ids.length} selected slip(s)? This cannot be undone.`)) return;
  let ok = 0, fail = 0;
  for(const id of ids){
    try { await deleteRecord(id); ok++; } catch { fail++; }
  }
  $('status').textContent = `Deleted ${ok} slip(s). ${fail? fail+' failed.':''}`;
  await refresh();
});

$('btnDeleteAll').addEventListener('click', async ()=>{
  const msg = prompt('Type DELETE to erase ALL slips. No backsies.');
  if(msg !== 'DELETE') return;
  await clearAllRecords();
  $('status').textContent = 'All slips deleted.';
  await refresh();
});

$('btnExport').addEventListener('click', async ()=>{
  const data = await getAllRecords();
  const blob = new Blob([JSON.stringify({ exportedAt:new Date().toISOString(), count:data.length, slips:data }, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `pms_slips_backup_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
  document.body.appendChild(a); a.click(); a.remove();
});

$('btnImport').addEventListener('click', ()=> $('fileImport').click());
$('fileImport').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  try{
    const text = await file.text();
    const json = JSON.parse(text);
    const slips = Array.isArray(json) ? json : (json.slips || []);
    if(!Array.isArray(slips) || !slips.length){ alert('No slips found in file.'); return; }
    const mode = confirm('OK = Add to existing. Cancel = Replace all first.');
    if(!mode){
      const msg = prompt('Type REPLACE to clear DB then import.');
      if(msg !== 'REPLACE') return;
      await clearAllRecords();
    }
    for(const s of slips){
      const { id, ...rest } = s; // let IndexedDB assign fresh IDs
      await addRecord(rest);
    }
    $('status').textContent = `Imported ${slips.length} slip(s).`;
    await refresh();
  }catch(err){
    console.error(err);
    alert('Import failed. Check console.');
  }finally{
    e.target.value = '';
  }
});

$('btnRefresh').addEventListener('click', refresh);
$('btnPrint').addEventListener('click', ()=> window.print());
['q','bld','from','to'].forEach(id => $(id).addEventListener('input', renderTable));

/* ------------------------------ Boot ------------------------------ */
async function refresh(){
  CACHE = await getAllRecords();
  populateBuildings();
  renderTable();
  $('preview').classList.add('muted');
  $('preview').textContent = 'Select a row to preview its details. I’m not psychic.';
  $('status').textContent = `${CACHE.length} slip(s) in DB.`;
}

refresh().catch(err=>{
  console.error(err);
  $('status').textContent = 'Could not open the local DB. Open your slip page first and save something.';
});
</script>
</body>
</html>
